openapi: 3.0.3
info:
  title: Duck-Hack Cloud API
  version: 1.0.0
  description: >
    API base del proyecto CRM/eCommerce (estado actual).
    Incluye autenticación, gestión de usuarios, contacto por correo y archivos públicos.
servers:
  - url: http://localhost:5000
    description: Local backend
  - url: http://localhost:83
    description: Docker Compose backend
tags:
  - name: Auth
  - name: Users
  - name: Mail
  - name: Uploads
paths:
  /api/users/register:
    post:
      tags: [Auth]
      summary: Registrar usuario customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Usuario creado correctamente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/EmailAlreadyRegistered"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/users/verify:
    get:
      tags: [Auth]
      summary: Verificar cuenta por token de correo
      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Cuenta verificada o ya verificada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Token faltante o inválido/expirado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          $ref: "#/components/responses/UserNotFound"

  /api/users/login:
    post:
      tags: [Auth]
      summary: Iniciar sesión
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login exitoso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Credenciales inválidas
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Cuenta no verificada o rol no soportado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/users:
    get:
      tags: [Users]
      summary: Listar usuarios
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Lista de usuarios
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserListItem"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/users/{id}:
    get:
      tags: [Users]
      summary: Obtener usuario por id
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/UserIdParam"
      responses:
        "200":
          description: Usuario encontrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPublic"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    put:
      tags: [Users]
      summary: Actualizar usuario (datos generales y/o rol)
      description: >
        No permite cambiar email. Soporta multipart/form-data para profileImage.
        El archivo se valida por contenido real (no solo mimetype) y se aceptan únicamente JPG/PNG.
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/UserIdParam"
      requestBody:
        required: false
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/UpdateUserRequest"
      responses:
        "200":
          description: Usuario actualizado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateUserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags: [Users]
      summary: Eliminar usuario por id
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/UserIdParam"
      responses:
        "200":
          description: Usuario eliminado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteUserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/users/{id}/password:
    patch:
      tags: [Users]
      summary: Cambiar contraseña del usuario autenticado
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/UserIdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
      responses:
        "200":
          description: Contraseña actualizada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/mail/send-email:
    post:
      tags: [Mail]
      summary: Enviar correo de contacto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContactEmailRequest"
      responses:
        "200":
          description: Correo enviado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          description: Error SMTP
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/uploads/products-image:
    post:
      tags: [Uploads]
      summary: Subir imagen de producto
      description: >
        Requiere autenticación y rol administrativo (`super_admin`, `store_admin`, `catalog_manager`).
        El archivo se valida por contenido real y se acepta únicamente JPG/PNG (máx. 5MB).
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                productImage:
                  type: string
                  format: binary
                  description: Imagen del producto en JPG o PNG
              required: [productImage]
      responses:
        "201":
          description: Imagen de producto subida correctamente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductImageUploadResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /uploads/{fileName}:
    get:
      tags: [Uploads]
      summary: Obtener archivo estático subido
      parameters:
        - in: path
          name: fileName
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Archivo servido por Express static
        "404":
          $ref: "#/components/responses/RouteNotFound"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: >
        JWT de acceso (tokenType=access) firmado con HS256.
        Validación estricta de issuer (JWT_ISSUER) y audience (JWT_AUDIENCE).

  parameters:
    UserIdParam:
      in: path
      name: id
      required: true
      schema:
        type: string
      description: ObjectId de usuario

  responses:
    BadRequest:
      description: Solicitud inválida
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: No autenticado o token inválido
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: Sin permisos para la operación
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    UserNotFound:
      description: Usuario no encontrado
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    EmailAlreadyRegistered:
      description: El correo ya está registrado
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    InternalServerError:
      description: Error interno del servidor
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    TooManyRequests:
      description: Demasiadas solicitudes en una ventana de tiempo
      headers:
        Retry-After:
          description: Segundos recomendados para reintentar
          schema:
            type: integer
        X-RateLimit-Limit:
          description: Límite de solicitudes para la ventana
          schema:
            type: integer
        X-RateLimit-Remaining:
          description: Solicitudes restantes en la ventana actual
          schema:
            type: integer
        X-RateLimit-Reset:
          description: Epoch en segundos cuando se reinicia la ventana
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            rateLimitExceeded:
              summary: Ejemplo de límite excedido
              value:
                ok: false
                error:
                  status: 429
                  code: RATE_LIMIT_LOGIN_EXCEEDED
                  message: Demasiados intentos de inicio de sesión. Intenta nuevamente más tarde.
                  details:
                    retryAfterSec: 120
    RouteNotFound:
      description: Ruta no encontrada
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    Role:
      type: string
      enum:
        - super_admin
        - store_admin
        - catalog_manager
        - order_manager
        - customer

    UserPublic:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        role:
          $ref: "#/components/schemas/Role"
        profileImage:
          type: string
          nullable: true
        isVerified:
          type: boolean
        createdAt:
          type: string
          format: date-time
      required: [_id, name, email, role, isVerified, createdAt]

    UserListItem:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        role:
          $ref: "#/components/schemas/Role"
        isVerified:
          type: boolean
        createdAt:
          type: string
          format: date-time
      required: [_id, name, email, role, isVerified, createdAt]

    RegisterRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 80
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6
      required: [name, email, password]

    RegisterResponse:
      type: object
      properties:
        message:
          type: string
        user:
          $ref: "#/components/schemas/UserPublic"
      required: [message, user]

    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required: [email, password]

    LoginResponse:
      type: object
      properties:
        message:
          type: string
        token:
          type: string
        user:
          $ref: "#/components/schemas/UserPublic"
      required: [message, token, user]

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 80
        role:
          $ref: "#/components/schemas/Role"
        profileImage:
          type: string
          format: binary
          description: Imagen real en formato JPG o PNG (máximo 5MB).

    UpdateUserResponse:
      type: object
      properties:
        message:
          type: string
        user:
          $ref: "#/components/schemas/UserPublic"
      required: [message, user]

    ChangePasswordRequest:
      type: object
      properties:
        currentPassword:
          type: string
        newPassword:
          type: string
          minLength: 6
      required: [currentPassword, newPassword]

    DeleteUserResponse:
      type: object
      properties:
        message:
          type: string
        user:
          $ref: "#/components/schemas/UserPublic"
      required: [message, user]

    ContactEmailRequest:
      type: object
      properties:
        fullName:
          type: string
          minLength: 2
          maxLength: 100
        email:
          type: string
          format: email
        phone:
          type: string
          maxLength: 30
        service:
          type: string
          maxLength: 120
        message:
          type: string
          minLength: 10
          maxLength: 2000
      required: [fullName, email, service, message]

    MessageResponse:
      type: object
      properties:
        message:
          type: string
      required: [message]

    ProductImageUploadResponse:
      type: object
      properties:
        message:
          type: string
        imagePath:
          type: string
          example: uploads/productImage-1718282784-uuid.jpg
      required: [message, imagePath]

    ErrorResponse:
      type: object
      properties:
        ok:
          type: boolean
          enum: [false]
        error:
          type: object
          properties:
            status:
              type: integer
              example: 400
            code:
              type: string
              example: VALIDATION_ERROR
            message:
              type: string
            details:
              oneOf:
                - type: string
                - type: object
                - type: array
                  items: {}
          required: [status, code, message]
      required: [ok, error]
